<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
  body { font-family: Arial; background: #111; color: #fff; display:flex; justify-content:center; align-items:center; height:100vh; }
  .container { background: rgba(0,0,0,0.8); padding:30px; border-radius:15px; width:400px; box-shadow:0 0 20px #00f; position:relative; }
  h2 { text-align:center; margin-bottom:20px; color:#0ff; }
  input, select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:none; }
  button { padding:10px; width:100%; margin-top:10px; border:none; border-radius:8px; cursor:pointer; background:#0ff; color:#000; font-weight:bold; }
  button:hover { background:#0aa; color:#fff; }
  #createUserSection { display:none; margin-top:20px; border-top:1px solid #0ff; padding-top:20px; }

  /* Loader */
  .loader { border:4px solid #333; border-top:4px solid #0ff; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; margin:auto; display:none; }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* Toast */
  #toast { visibility:hidden; min-width:200px; background:#0ff; color:#000; text-align:center; border-radius:8px; padding:10px; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:9999; font-weight:bold; }
  #toast.show { visibility:visible; animation:fadein 0.5s, fadeout 0.5s 2.5s; }
  @keyframes fadein { from { bottom:10px; opacity:0; } to { bottom:30px; opacity:1; } }
  @keyframes fadeout { from { bottom:30px; opacity:1; } to { bottom:10px; opacity:0; } }

  /* Password strength */
  #passwordStrength { font-size: 0.9em; margin-top: -5px; margin-bottom: 8px; }
  .weak { color: #f33; }
  .medium { color: #ff0; }
  .strong { color: #0f0; }
</style>
</head>
<body>

<div class="container">
  <h2>Admin Panel</h2>

  <!-- Loader -->
  <div class="loader" id="loader"></div>

  <!-- Login Section -->
  <div id="loginSection">
    <input type="text" id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="showCreateUser()">Create User</button>
    <p id="loginMessage"></p>
  </div>

  <!-- Create User Section -->
  <div id="createUserSection">
    <h3>Create New User</h3>
    <input type="text" id="newUsername" placeholder="Username" />
    <input type="password" id="newPassword" placeholder="Password" onkeyup="checkPasswordStrength()" />
    <div id="passwordStrength"></div>
    <!-- Restricted to Agent only -->
    <select id="newRole" disabled>
      <option value="Agent" selected>Agent</option>
    </select>
    <button onclick="createUser()">Create</button>
    <p id="createMessage"></p>
    <button onclick="backToLogin()">Back to Login</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxsafwnEo9sXUaHgkKVYhw0C5qVvfaFq1PRNB1Q-ig2BWDTFzTI9vrxjj4mtl-0biOW/exec";

// Rights
function getDefaultRights(role) {
  if (role === "Agent") return ["leads","buyers","sellers","properties","tasks"];
  return [];
}

// üîî Toast
function showToast(msg, success=true) {
  const toast=document.getElementById("toast");
  toast.innerText=msg;
  toast.style.background = success ? "#0ff" : "#f33";
  toast.style.color = success ? "#000" : "#fff";
  toast.className="show";
  setTimeout(()=>toast.className=toast.className.replace("show",""),3000);
}

// Loader
function showLoader(show){
  document.getElementById("loader").style.display = show ? "block" : "none";
}

// Password strength check
function checkPasswordStrength(){
  const pass=document.getElementById("newPassword").value;
  const strengthEl=document.getElementById("passwordStrength");
  let strength="Weak";
  let cls="weak";

  const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  const mediumRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/;

  if(strongRegex.test(pass)){ strength="Strong"; cls="strong"; }
  else if(mediumRegex.test(pass)){ strength="Medium"; cls="medium"; }

  strengthEl.innerText="Password strength: " + strength;
  strengthEl.className=cls;
}

// Show create user form
function showCreateUser(){
  document.getElementById('loginSection').style.display='none';
  document.getElementById('createUserSection').style.display='block';
}

// Back to login form
function backToLogin(){
  document.getElementById('createUserSection').style.display='none';
  document.getElementById('loginSection').style.display='block';
}

// Login
async function login(){
  const username=document.getElementById('loginUsername').value.trim();
  const password=document.getElementById('loginPassword').value.trim();
  if(!username || !password){ showToast("‚ö† Please enter credentials", false); return; }

  showLoader(true);
  try {
    const res = await fetch(WEBAPP_URL,{method:'POST',body:JSON.stringify({action:'loginUser',username,password})});
    const data = await res.json();
    if(data.success){
      sessionStorage.setItem('user',JSON.stringify(data.user));
      showToast("‚úÖ Login successful!");
      setTimeout(()=>{ window.location.href='Realestate.html'; },1000);
    } else {
      showToast("‚ùå " + data.message, false);
    }
  } catch(e){
    showToast("‚ùå Network error", false);
  } finally {
    showLoader(false);
  }
}

// Create user
async function createUser(){
  const username=document.getElementById('newUsername').value.trim();
  const password=document.getElementById('newPassword').value.trim();
  const role="Agent";

  const strongRegex=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
  if(!username || !password){ showToast("‚ö† Enter username & password", false); return; }
  if(!strongRegex.test(password)){ showToast("‚ö† Password not strong enough", false); return; }

  const rights=getDefaultRights(role);

  showLoader(true);
  try {
    const res = await fetch(WEBAPP_URL,{method:'POST',body:JSON.stringify({action:'addUser',username,password,role,rights})});
    const data = await res.json();
    if(data.success){ 
      showToast("‚úÖ " + data.message); 
      document.getElementById('newUsername').value="";
      document.getElementById('newPassword').value="";
      document.getElementById('passwordStrength').innerText="";
      backToLogin();
    } else { showToast("‚ùå " + data.message, false); }
  } catch(e){ showToast("‚ùå Network error", false); }
  finally { showLoader(false); }
}
</script>
</body>
</html>
